@using FullStopDotNet2014.Common.ExtensionMethods
@using FullStopDotNet2014.Web.Extensions

@*TODO: Download editor instead of using CDN*@

<!-- load the jQuery and require.js libraries -->
<script type="text/javascript" src="http://cdn.aloha-editor.org/latest/lib/require.js"></script>
<!-- Aloha uses some deprecated functions in JQuery, so we can't use latest -->
<script type="text/javascript" src="http://cdn.aloha-editor.org/latest/lib/vendor/jquery-1.7.2.js"></script>

<!-- here we have our Aloha Editor config -->
<script>
    (function (window) {
        var Aloha = window.Aloha || (window.Aloha = {});
        Aloha.settings = {
            // Restore the global $ and jQuery variables of your project's jQuery
            jQuery: window.jQuery.noConflict(true),
            logLevels: { 'error': true, 'warn': true, 'info': true, 'debug': false, 'deprecated': true },
            errorhandling: false,
            ribbon: false,
            locale: 'en',
            floatingmenu: {
                width: 630,
                behaviour: 'topalign'
            },
            repositories: {
                linklist: {
                    data: [
                        { name: 'Aloha Editor - The HTML5 Editor', url: 'http://aloha-editor.com', type: 'website', weight: 0.90 },
                        { name: 'Aloha Demo', url: 'http://www.aloha-editor.com/demos.html', type: 'website', weight: 0.75 },
                        { name: 'Aloha Logo', url: 'http://www.aloha-editor.com/images/aloha-editor-logo.png', type: 'image', weight: 0.10 }
                    ]
                }
            },
            plugins: {
                format: {
                    // all elements with no specific configuration get this configuration
                    config: ['b', 'i', 'p', 'sub', 'sup', 'del', 'title', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'pre', 'removeFormat', 'myButton'],
                    editables: {
                        // no formatting allowed for title
                        '#top-text': []
                    }
                }
            },
            toolbar: {
                tabs: [
                    {
                        label: 'Save / Cancel',
                        components: ['savebutton', 'cancelbutton']

                    }
                ],
                exclude: ['strong', 'emphasis', 'strikethrough']
            }
        };
    })(window);
</script>

<script src="http://cdn.aloha-editor.org/latest/lib/aloha.js"
        data-aloha-plugins="common/ui,
								common/format,
								common/table,
								common/list,
								common/link,
								common/highlighteditables,
								common/block,
								common/undo,
								common/contenthandler,
								common/paste,
								common/commands,
								common/abbr,
								common/image"></script>

<link rel="stylesheet" href="http://cdn.aloha-editor.org/latest/css/aloha.css" type="text/css">
<script>
    Aloha.ready(function () {
        Aloha.require(['ui/ui', 'ui/button'], function(Ui, Button) {
            Ui.adopt("savebutton", Button, {
                text: 'Save',
                click: function() {
                    var content = Aloha.activeEditable.getContents();
                    var contentId = Aloha.activeEditable.obj[0].id;
                    
                    var request = jQuery.ajax({
                        url: "@Url.HttpRouteUrl("SaveTextResource", null)",
                        type: "POST",
                        data: {
                            value: content,
                            resouceKey: contentId
                        },
                        dataType: "html"
                    });

                    request.done(function(msg) {
                        Aloha.jQuery("#log").html(msg).show().delay(1500).fadeOut();
                        Aloha.activeEditable.originalContent = content;
                    });

                    request.error(function(jqXHR, textStatus) {
                        alert("Request failed: " + textStatus);
                    });
                }
            });

            Ui.adopt("cancelbutton", Button, {
                text: 'Cancel',
                click: function() {
                    Aloha.activeEditable.setContents(Aloha.activeEditable.originalContent);
                }
            });
        });
    });
</script>
<!-- make all elements with class="editable" editable with Aloha Editor -->
<script type="text/javascript">
    Aloha.ready(function () {
        var $ = Aloha.jQuery;
        $('.@Html.EditableClass()').aloha();
        $('.aloha-textarea').height('auto').width('auto');
    });
</script>
